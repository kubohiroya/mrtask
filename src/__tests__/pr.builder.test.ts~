import { describe, it, expect } from "vitest";
import { makeTitle, summariseByWorkDir, makeBody } from "../pr/builder.js";

describe("builder functions", () => {
  it("summarises by workDir", () => {
    const files = ["packages/app/src/a.ts", "packages/core/b.ts", "README.md"];
    const s = summariseByWorkDir(files, ["packages/app", "packages/core"]);
    expect(s.byWorkDir["packages/app"]).toContain("packages/app/src/a.ts");
    expect(s.byWorkDir["packages/core"]).toContain("packages/core/b.ts");
  });
  it("title has scope and id", () => {
    const t = {
      id: "2025-09-08T00-00-00Z-feature_x",
      title: "Hello",
      branch: "feature/x",
      status: "open",
      createdAt: "now",
      primaryDir: "packages/app",
      workDirs: ["packages/app"]
    } as any;
    const s = summariseByWorkDir([], t.workDirs);
    const title = makeTitle(t, s);
    expect(title).toMatch(/\[app\] Hello/);
    expect(title).toMatch(/mrtask:/);
  });
  it("body has sections", () => {
    const t = {
      id: "id",
      title: "T",
      description: "D",
      branch: "b",
      status: "open",
      createdAt: "now",
      primaryDir: "packages/app",
      workDirs: ["packages/app"]
    } as any;
    const s = summariseByWorkDir(["packages/app/x.ts"], t.workDirs);
    const body = makeBody(t, s);
    expect(body).toContain("## Summary");
    expect(body).toContain("## Changes");
    expect(body).toContain("packages/app");
  });
});
